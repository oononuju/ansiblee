- hosts: localhost
  gather_facts: false
  tasks:
    - ssh_keygen:
        type: ed25519
        passphrase: passphrase
      register: sshkey

    - delegate_to: testhost
      block:
        - slurp:
            path: ~/.ssh/authorized_keys
          register: akeys

        - debug:
            msg: '{{ akeys.content|b64decode }}'

        - copy:
            content: |
              {{ sshkey.public_key }}
              {{ akeys.content|b64decode }}
            dest: ~/.ssh/authorized_keys
            mode: '0400'

    - add_host:
        name: testhost
        ansible_password: ~
        ansible_ssh_password: ~
        ansible_ssh_private_key_file: ~
        ansible_private_key: '{{ sshkey.private_key }}'
        ansible_private_key_passphrase: passphrase
        fingerprint: '{{ sshkey.fingerprint }}'

- hosts: testhost
  gather_facts: false
  tasks:
    - ping:

    - name: list keys from agent
      ssh_agent:
        action: list
      register: keys

    - assert:
        that:
          - keys.nkeys == 1
          - keys['keys'][0].fingerprint == fingerprint

    - name: lock the agent
      ssh_agent:
        action: lock
        password: pancakes

    - name: this will fail because the agent is locked
      ping:
      ignore_errors: true
      register: _
      failed_when: _ is not failed

    - name: unlock the agent
      ssh_agent:
        action: unlock
        password: pancakes

    - ping:
