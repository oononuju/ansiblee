"""
Test decryption of various canned inputs for each defined vault method.
Ensures that the current implementation can decrypt values generated by a previous version of the vault code.
Also fails if at least one test scenario is not present under `decrypt_test_data` for each vault method.
"""

from __future__ import annotations

import importlib.resources
import pytest

from ansible.parsing.vault import VaultLib, VaultSecret, parse_vaulttext_envelope

from . import decrypt_test_data
from .plugins.test_methods import vault_loader


def get_plugin_names() -> list[str]:
    # add rot13 and any other test plugins
    plugins = vault_loader.all()
    for p in plugins:
        yield p._ansible_name.split('.')[-1]


def get_decrypt_test_scenarios(plugins: list[str]) -> list[tuple[str, str]]:
    params = []
    for plugin_name in plugins:
        with importlib.resources.as_file(importlib.resources.files(decrypt_test_data).joinpath(plugin_name)) as path:
            if not (scenarios := list(path.glob('*.ciphertext'))):  # pragma: nocover
                params.append((plugin_name, "MISSING"))
            for scenario in scenarios:
                params.append((plugin_name, scenario.with_suffix('').name))

    return params


@pytest.mark.parametrize("plugin_name, scenario", get_decrypt_test_scenarios(get_plugin_names()))
def test_fixed_decrypt(plugin_name: str, scenario: str) -> None:
    with importlib.resources.as_file(importlib.resources.files(decrypt_test_data).joinpath(plugin_name)) as path:
        ciphertext_path = path.joinpath(scenario).with_suffix('.ciphertext')
        plaintext_path = path.joinpath(scenario).with_suffix('.plaintext')
        secret_path = ciphertext_path.with_name(ciphertext_path.name.split('_', 1)[0])
        assert ciphertext_path.exists()
        assert plaintext_path.exists()
        assert secret_path.exists()
        # FIXME: expose static methods on VaultLib to make this suck less
        assert parse_vaulttext_envelope(ciphertext_path.read_bytes())[2] == plugin_name.upper()

        vault = VaultLib(secrets=[('default', VaultSecret(secret_path.read_bytes()))])
        assert vault.decrypt(ciphertext_path.read_bytes(), ciphertext_path.absolute()) == plaintext_path.read_bytes()
